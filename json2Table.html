<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic JSON to Editable Table </title>
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
            margin: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        td.editable {
            cursor: pointer;
        }

        td.editable:hover {
            background-color: #f0f0f0;
        }

        #json-input {
            width: 60%;
            padding: 5px;
            margin: 10px;
        }

        #json-button {
            padding: 8px;
            margin: 10px;
            cursor: pointer;
        }

        #loading {
            display: none;
        }

        .edit-input {
            width: 80%;
        }
    </style>
</head>
<body>

    <h1>Dynamic JSON to Editable Table with API</h1>

    <input type="text" id="json-input" placeholder="Enter JSON data link">
    <button id="json-button" onclick="fetchAndCreateTable()">Create Table</button>

    <div id="table-container"></div>
    <div id="loading">Loading...</div>

    <script>
        async function fetchAndCreateTable() {
            var jsonLink = document.getElementById("json-input").value;
            var loadingIndicator = document.getElementById("loading");

            try {
                loadingIndicator.style.display = "block";

                var response = await fetch(jsonLink);

                if (!response.ok) {
                    throw new Error(`Failed to fetch JSON (${response.status} ${response.statusText})`);
                }

                var jsonData = await response.json();

                var tableContainer = document.getElementById("table-container");
                tableContainer.innerHTML = '';

                var table = document.createElement("table");

                var thead = document.createElement("thead");
                var headerRow = document.createElement("tr");

                var idTh = document.createElement("th");
                idTh.textContent = "id";
                headerRow.appendChild(idTh);

                var uniqueKeys = new Set();

                jsonData.forEach(function (item) {
                    for (var key in item) {
                        uniqueKeys.add(key);
                    }
                });

                uniqueKeys.forEach(function (key) {
                    if (key !== "id") {
                        var th = document.createElement("th");
                        th.textContent = key;
                        headerRow.appendChild(th);
                    }
                });

                thead.appendChild(headerRow);
                table.appendChild(thead);

                var tbody = document.createElement("tbody");

                jsonData.forEach(function (item) {
                    var row = document.createElement("tr");

                    var idCell = document.createElement("td");
                    idCell.textContent = item.id;
                    row.appendChild(idCell);

                    uniqueKeys.forEach(function (key) {
                        if (key !== "id") {
                            var cell = document.createElement("td");
                            cell.textContent = typeof item[key] === 'object' ? (item[key] !== null ? JSON.stringify(item[key]) : "") : (item[key] !== null ? item[key] : '');
                            cell.classList.add("editable");
                            cell.setAttribute("contenteditable", "true");
                            row.appendChild(cell);

                            (function (currentKey) {
                                cell.addEventListener("input", function () {
                                    item[currentKey] = cell.textContent;
                                });

                                cell.addEventListener("keydown", function (event) {
                                    if (event.key === "Enter") {
                                        event.preventDefault();
                                        var editedColumn = currentKey;
                                        triggerApi(item, editedColumn);
                                    }
                                });
                            })(key);
                        }
                    });

                    tbody.appendChild(row);
                });

                table.appendChild(tbody);

                tableContainer.appendChild(table);
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                loadingIndicator.style.display = "none";
            }
        }

        async function triggerApi(data, editedColumn) {
            var apiEndpoint = 'https://demodpd.kore.ai/sbaccounts';

            try {
                var updatedData = {
                    id: data.id,
                };

                updatedData[editedColumn] = data[editedColumn];
            
                var response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedData),
                });

                if (!response.ok) {
                    throw new Error(`Failed to update data (${response.status} ${response.statusText})`);
                }

                alert('Data updated successfully!');
            } catch (error) {
                alert(`Error updating data: ${error.message}`);
            }
        }
    </script>

</body>
</html>
